import ply.yacc as yacc
from lexer import tokens
import json
import sys

# Definición de la gramática

# regla1
def p_Sigma(p):
    '''Sigma : lla EmpresasI comma Version comma Firma_digital llc
             | lla EmpresasI comma Firma_digital comma Version llc
             | lla Version comma EmpresasI comma Firma_digital llc
             | lla Version comma Firma_digital comma pa EmpresasI pc llc
             | lla Firma_digital comma Version comma EmpresasI llc
             | lla Firma_digital comma EmpresasI comma Version llc
             | lla EmpresasI comma Version llc
             | lla EmpresasI comma Firma_digital llc
             | lla EmpresasI llc '''
             
# regla2
def p_EmpresasI(p):
    '''EmpresasI : dp pa Empresas pc'''

# regla
def p_Empresas(p):
    '''Empresas : lla EmpresaE llc'''

# regla
def p_EmpresaE(p):
    '''EmpresaE : EmpresaE
                | Empresa'''

# regla
def p_Empresa(p):
    '''Empresa : lla Nombre_empresa comma Fundacion comma Direccion comma Ingresos_anuales comma Pyme comma Link comma Departamentos llc
               | lla Nombre_empresa comma Fundacion comma Direccion comma Ingresos_anuales comma Pyme comma Departamentos llc'''

# regla
def p_Nombre_empresa(p):
    '''Nombre_empresa : nombre_empresa dp string'''

# regla
def p_Direccion(p):
    '''Direccion : lla Calle comma ciudad comma Pais llc
                 | lla Calle comma Pais comma ciudad llc
                 | lla ciudad comma Calle comma Pais llc
                 | lla ciudad comma Pais comma Calle llc
                 | lla Pais comma Calle comma ciudad llc
                 | lla Pais comma ciudad comma Calle llc
                 | lla llc'''

# regla
def p_Departamentos(p):
    '''Departamentos : pa DepartamentoD pc'''

# regla
def p_DepartamentoD(p):
    '''DepartamentoD : DepartamentoD
                     | Departamento'''

# regla
def p_Departamento(p):
    '''Departamento : lla Nombre comma Jefe comma Subdepartamentos llc
                    | lla Nombre comma Subdepartamentos llc
                    | lla Subdepartamentos comma Nombre comma Jefe llc
                    | lla Subdepartamentos comma Nombre llc
                    | lla Jefe comma Nombre comma Subdepartamentos llc
                    | lla Jefe comma Subdepartamentos comma Nombre llc'''   

# regla
def p_Subdepartamentos(p):
    '''Subdepartamentos : pa SubdepartamentoS pc'''

# regla
def p_SubdepartamentoS(p):
    '''SubdepartamentoS : SubdepartamentoS 
                        | Subdepartamento'''

# regla
def p_Subdepartamento(p):
    '''Subdepartamento : lla Nombre comma Jefe comma Empleados llc
                       | lla Nombre llc
                       | lla Nombre comma Jefe llc
                       | lla Nombre comma Empleados llc'''

# regla
def p_Empleados(p):
    '''Empleados : pa EmpleadoE pc
                 | pa pc'''

# regla   
def p_EmpleadoE(p):
    '''EmpleadoE : EmpleadoE 
                 | Empleado'''

# regla
def p_Empleado(p):
    '''Empleado : lla nombre comma Edad comma Cargo comma Salario comma Activo comma Fecha_contratacion comma Proyectos llc
                | lla nombre comma Cargo comma Salario comma Activo comma Fecha_contratacion llc
                | lla nombre comma Cargo comma Edad comma Salario comma Activo comma Fecha_contratacion comma Proyectos llc'''

# regla
def p_Proyectos(p):
    '''Proyectos : pa ProyectoP pc
                 | pa pc'''

# regla
def p_ProyectoP(p):
    '''ProyectoP : ProyectoP 
                 | Proyecto'''

# regla
def p_Proyecto(p):
    '''Proyecto : lla nombre comma estado comma Fecha_inicio comma Fecha_fin llc
                | lla nombre comma Fecha_inicio llc
                | lla nombre comma Estado comma Fecha_inicio llc'''

# deriva de Sigma
# regla
def p_Version(p):
    '''Version : version dp null
               | version dp string'''

# regla
def p_Firma_digital(p):
    '''Firma_digital : firma_digital dp string
                     | firma_digital dp null'''

# regla
def p_Estado(p):
    '''Estado : estado dp ESTADO_PROYECTO
              | estado dp null'''

# regla
def p_Jefe(p):
    '''Jefe : jefe dp null
            | jefe dp string'''

# regla
def p_Link(p):
    '''Link : link dp patron_url
            | link dp null'''

# regla
def p_Fecha_inicio(p):
    '''Fecha_inicio : fecha_inicio dp date'''

# regla
def p_Fecha_fin(p):
    '''Fecha_fin : fecha_fin dp null
                 | fecha_fin dp date'''

# regla
def p_Fecha_contratacion(p):
    '''Fecha_contratacion : fecha_contratacion dp date'''

# regla
def p_Nombre(p):
    '''Nombre : nombre dp string'''

# regla
def p_Pais(p):
    '''Pais : pais dp string'''

# regla
def p_Calle(p):
    '''Calle : calle dp string'''

# regla
def p_Ciudad(p):
    '''Ciudad : ciudad dp string'''

# regla
def p_Fundacion(p):
    '''Fundacion : fundacion dp integer'''

# regla
def p_Activo(p):
    '''Activo : activo dp bool'''

# regla
def p_Pyme(p):
    '''Pyme : pyme dp bool'''

# regla
def p_Ingresos_anuales(p):
    '''Ingresos_anuales : ingresos_anuales dp float'''

# regla
def p_Cargo(p):
    '''Cargo : cargo dp CARGO_EMPLEADO'''

# regla
def p_Salario(p):
    '''Salario : salario dp float'''

# regla
def p_Edad(p):
    '''Edad : edad dp integer'''
    
def p_error(p):
    print(f"Error de sintaxis en '{p.value}'")

parser = yacc.yacc()

def main():
    if len(sys.argv) != 2:
        print("Uso: python parser.py <archivo_json>")
        sys.exit(1)

    archivo_json = sys.argv[1]
    
    try:
        with open(archivo_json, 'r', encoding='utf-8') as archivo:
            data = json.load(archivo)
            result = parser.parse(json.dumps(data))
            print(result)
    except FileNotFoundError:
        print(f"El archivo {archivo_json} no se encontró.")
    except json.JSONDecodeError:
        print(f"Error al decodificar el archivo JSON {archivo_json}.")

if __name__ == "__main__":
    main()
